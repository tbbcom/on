(()=>{const $=e=>document.querySelector(e),$$=e=>Array.from(document.querySelectorAll(e)),canvas=$("#ib-canvas")||document.createElement("canvas");if(!canvas.id)canvas.id="ib-canvas",document.querySelector("#ib-editor").appendChild(canvas);const ctx=canvas.getContext("2d"),DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));let layers=[],active=-1,tool="move",painting=!1,start={x:0,y:0},paint={color:"#2b2b2b",size:24,opacity:1},history=[],hIndex=-1,MAX_H=30;const uid=()=> "ib_"+Math.random().toString(36).slice(2,9),clamp=(e,t,a)=>Math.max(t,Math.min(a,e)),toFilter=e=>`brightness(${e.br}) contrast(${e.co}) saturate(${e.sa}) blur(${e.bl}px) hue-rotate(${e.hu}deg)`,pushHistory=()=>{const e=JSON.stringify(layers.map(t=>({...t,data:"raster"===t.type?t.data.toDataURL("image/png"):void 0})));history.splice(hIndex+1),history.push(e),history.length>MAX_H&&history.shift(),hIndex=history.length-1},restoreFrom=e=>{const t=JSON.parse(e);layers=t.map(o=>{const r={...o};return"raster"===o.type&&o.data?new Promise(n=>{const i=new Image,c=document.createElement("canvas");i.onload=()=>{c.width=i.naturalWidth,c.height=i.naturalHeight,c.getContext("2d").drawImage(i,0,0),r.data=c,n(r)},i.src=o.data}):r}),layers.some(o=>o instanceof Promise)?Promise.all(layers).then(o=>{layers=o,active=layers.length?0:-1,render(),syncUI()}):(active=layers.length?0:-1,render(),syncUI())};function fitCanvasToContainer(){const e=canvas.parentElement,t=Math.min(1400,e.clientWidth-4),a=canvas.height/canvas.width,o=Math.max(360,t*a),r=Math.floor(t),n=Math.floor(o);canvas.style.width=r+"px",canvas.style.height=n+"px",canvas.width=Math.floor(r*DPR),canvas.height=Math.floor(n*DPR),ctx.setTransform(DPR,0,0,DPR,0,0),render()}window.addEventListener("resize",fitCanvasToContainer);function baseLayer(e,t){return{id:uid(),type:e,name:t,visible:!0,opacity:1,blend:"source-over",x:0,y:0,scale:1,rot:0,filter:{br:1,co:1,sa:1,bl:0,hu:0}}}function render(){const e=Math.round(canvas.width/DPR),t=Math.round(canvas.height/DPR);ctx.save(),ctx.setTransform(DPR,0,0,DPR,0,0),ctx.clearRect(0,0,e,t);for(const a of layers)if(a.visible){ctx.globalAlpha=clamp(a.opacity,0,1),ctx.globalCompositeOperation=a.blend||"source-over",ctx.filter=toFilter(a.filter),ctx.save(),ctx.translate(a.x,a.y),ctx.rotate((a.rot||0)*Math.PI/180),ctx.scale(a.scale||1,a.scale||1),"raster"===a.type&&a.data?ctx.drawImage(a.data,0,0):"shape"===a.type&&a.shape?(ctx.lineWidth=a.shape.size,ctx.strokeStyle=a.shape.color,ctx.fillStyle=a.shape.color,"rect"===a.shape.kind?ctx.fillRect(0,0,200,140):"ellipse"===a.shape.kind?(ctx.beginPath(),ctx.ellipse(100,70,100,70,0,0,2*Math.PI),ctx.fill()):"line"===a.shape.kind&&(ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(220,0),ctx.stroke())):"text"===a.type&&a.text&&(ctx.fillStyle=a.text.color,ctx.font=`${a.text.weight} ${a.text.size}px ${a.text.font}`,ctx.textAlign=a.text.align,ctx.textBaseline=a.text.baseline,ctx.fillText(a.text.value,0,0)),ctx.restore()}ctx.filter="none",ctx.globalAlpha=1,ctx.globalCompositeOperation="source-over",ctx.restore()}function syncUI(){const e=$("#ib-layer-list");if(e){e.innerHTML="",layers.forEach((t,a)=>{const o=document.createElement("li");o.dataset.index=a,o.className=a===active?"active":"",o.innerHTML=`<span>${t.name} â€¢ ${t.type}</span><span>${t.visible?"ğŸ‘":"ğŸš«"}</span>`,o.addEventListener("click",()=>{active=a,syncUI()}),e.prepend(o)})}}function undo(){if(hIndex<=0)return;hIndex--,restoreFrom(history[hIndex])}function redo(){if(hIndex>=history.length-1)return;hIndex++,restoreFrom(history[hIndex])}document.addEventListener("keydown",e=>{("z"===e.key.toLowerCase()&&(e.ctrlKey||e.metaKey))&&(e.shiftKey?redo():undo())}),fitCanvasToContainer();})();
